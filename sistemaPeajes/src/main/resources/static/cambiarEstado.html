<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cambiar Estado de Propietario</title>
    <link rel="stylesheet" href="styles/menuNavegacion.css" />
    <link rel="stylesheet" href="styles/cambiarEstado.css" />
    <script src="vistaWeb.js"></script>
  </head>
  <body>
    <!-- Men√∫ de navegaci√≥n -->
    <nav class="nav-menu">
      <div class="nav-container">
        <div class="nav-brand">
          <span class="nav-brand-icon">üõ£Ô∏è</span>
          <span>Sistema de Peajes - Admin</span>
        </div>
        <ul class="nav-links">
          <li><a href="emularTransito.html">Emular Tr√°nsito</a></li>
          <li><a href="asignarBonificacion.html">Asignar Bonificaci√≥n</a></li>
          <li><a href="cambiarEstado.html" class="active">Cambiar Estado</a></li>
        </ul>
        <div class="nav-actions">
          <button class="btn-logout-nav" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="card">
        <div class="card-header">
          <div class="icon-title">
            <span class="icon">üîÑ</span>
            <h1>Cambiar estado de propietario</h1>
          </div>
          <p class="subtitle">
            Ingresa la c√©dula, revise el estado actual y seleccione un nuevo estado
            (datos de ejemplo).
          </p>
        </div>

        <div class="card-body">
          <div class="layout-two-columns">
            <!-- Columna izquierda -->
            <div class="left-column">
              <div class="form-section">
                <label for="cedula">C√©dula de identidad</label>
                <input
                  type="text"
                  name="cedula"
                  id="cedula"
                  class="form-input"
                  placeholder="12345678"
                  required
                />
                <button onclick="buscarPropietario()" class="btn-primary">
                  Buscar
                </button>
              </div>
            </div>

            <!-- Columna derecha -->
            <div class="right-column">
              <div class="form-section">
                <label for="selectEstado">Estados definidos</label>
                <select name="posNuevoEstado" id="selectEstado" class="form-select" required>
                  <option value="-1" selected disabled>
                    Activo
                  </option>
                </select>
                <button onclick="cambiarEstado()" class="btn-primary">
                  Cambiar estado
                </button>
                <p class="note">El estado actual se mostrar√° preseleccionado.</p>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n del Propietario -->
          <div id="infoPropietario" class="info-card">
            <div class="info-header">Propietario</div>
            <div class="info-row">
              <span class="info-label">Nombre</span>
              <span class="info-value" id="propNombre">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">Estado actual</span>
              <span class="info-value" id="propEstadoContainer">-</span>
            </div>
          </div>

          <div id="mensajeResultado"></div>
        </div>

        <div class="card-footer">
          ¬© 2025 ‚Äî Administraci√≥n
        </div>
      </div>
    </div>

    <script src="utilesVista.js"></script>
    <script>
      // Configurar inicializaci√≥n de vista
      urlIniciarVista = "/cambiarEstado/vistaConectada";
      parametrosInicioVista = "";

      let propietarioActual = null;
      let estadosDisponibles = [];

      // Funci√≥n para obtener clase CSS seg√∫n el estado
      function getEstadoClass(estado) {
        const estadoLower = estado.toLowerCase();
        if (estadoLower.includes("habilitado")) return "estado-habilitado";
        if (estadoLower.includes("deshabilitado"))
          return "estado-deshabilitado";
        if (estadoLower.includes("suspendido")) return "estado-suspendido";
        if (estadoLower.includes("penalizado")) return "estado-penalizado";
        return "";
      }

      // Funciones para procesar respuestas del servidor
      function mostrar_estados(data) {
        estadosDisponibles = data;
        const select = document.getElementById("selectEstado");

        // Limpiar opciones existentes excepto la primera
        select.innerHTML =
          '<option value="-1" selected disabled>Seleccione un nuevo estado...</option>';

        // Agregar estados
        data.forEach((estado, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = estado;
          select.appendChild(option);
        });
      }

      function mostrar_propietario(data) {
        propietarioActual = data;

        // Mostrar informaci√≥n del propietario
        document.getElementById("propNombre").textContent = data.nombreCompleto;

        // Mostrar estado con badge
        const estadoContainer = document.getElementById("propEstadoContainer");
        const estadoClass = getEstadoClass(data.estado);
        estadoContainer.innerHTML = `<span class="estado-badge ${estadoClass}">${data.estado}</span>`;

        // Preseleccionar el estado actual en el dropdown
        const select = document.getElementById("selectEstado");
        for (let i = 0; i < select.options.length; i++) {
          if (select.options[i].text === data.estado) {
            select.selectedIndex = i;
            break;
          }
        }

        // Limpiar mensaje anterior
        document.getElementById("mensajeResultado").innerHTML = "";
      }

      function mostrar_mensaje(texto) {
        document.getElementById("mensajeResultado").innerHTML =
          '<div class="message success">‚úì ' + texto + "</div>";
      }

      function excepcionDeAplicacion(mensaje) {
        alert("‚ùå Error: " + mensaje);
      }

      // Funciones de botones
      function buscarPropietario() {
        const cedula = document.getElementById("cedula").value;
        if (!cedula) {
          alert("Debe ingresar una c√©dula");
          return;
        }
        const params = "cedula=" + encodeURIComponent(cedula);
        submit("/cambiarEstado/buscarPropietarioPorCedula", params);
      }

      async function cambiarEstado() {
        if (!propietarioActual) {
          alert("‚ùå Primero debe buscar un propietario");
          return;
        }

        const posNuevoEstado = document.getElementById("selectEstado").value;

        if (posNuevoEstado === "-1") {
          alert("‚ùå Debe seleccionar un estado");
          return;
        }

        const nuevoEstado = estadosDisponibles[posNuevoEstado];

        // Confirmar cambio
        const confirmar = await mostrarConfirmacion(
          `¬øEst√° seguro de cambiar el estado de ${propietarioActual.nombreCompleto} a ${nuevoEstado}?`,
          "S√≠, cambiar",
          "Cancelar"
        );

        if (!confirmar) return;

        const params =
          "cedula=" +
          encodeURIComponent(propietarioActual.cedula) +
          "&posNuevoEstado=" +
          posNuevoEstado;
        submit("/cambiarEstado/cambiarEstado", params);
      }

      // Funci√≥n para cerrar sesi√≥n
      function cerrarSesion() {
        submit('/acceso/admin/logout', '');
      }

      function mostrar_Logout_exitoso(destino) {
        window.location.href = destino;
      }

      function mostrar_No_hay_usuario_logueado(destino) {
        window.location.href = destino;
      }

      function mostrar_usuarioNoAutenticado(destino) {
        window.location.href = destino;
      }
    </script>
  </body>
</html>
