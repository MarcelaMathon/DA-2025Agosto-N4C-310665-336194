<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emular tr√°nsito</title>
    <link rel="stylesheet" href="styles/emularTransito.css" />
    <script src="vistaWeb.js"></script>
  </head>
  <body>
    <div class="header">
      <div class="icon">üöó</div>
      <h1>Emular tr√°nsito</h1>
    </div>
    <p class="subtitle">
      Seleccione un puesto, verifique sus tarifas, ingrese una matr√≠cula y emule
      un tr√°nsito.
    </p>

    <div class="container">
      <form id="formEmularTransito">
        <div class="layout">
          <!-- Columna izquierda -->
          <div class="column">
            <div class="form-group">
              <label for="puesto">Puesto</label>
              <select id="puesto" name="posPuesto" required>
                <option value="">Seleccione un puesto</option>
              </select>
            </div>

            <div class="form-group">
              <label for="matricula">Matr√≠cula</label>
              <input
                type="text"
                id="matricula"
                name="matricula"
                placeholder="Ej: ABC1234"
                required
              />
            </div>

            <div class="form-group">
              <label for="fechaHora">Fecha y hora del tr√°nsito</label>
              <input
                type="datetime-local"
                id="fechaHora"
                name="fechaHora"
                required
              />
            </div>

            <button type="submit">Emular tr√°nsito</button>
            <div id="errorMessage"></div>
          </div>

          <!-- Columna derecha -->
          <div class="column">
            <div class="tarifas-container">
              <div class="tarifas-title">Tarifas del puesto</div>
              <table class="tarifas-table" id="tablaTarifas">
                <thead>
                  <tr>
                    <th>Categor√≠a</th>
                    <th>Monto</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="2" style="text-align: center; color: #9ca3af">
                      Seleccione un puesto
                    </td>
                  </tr>
                </tbody>
              </table>
              <p class="tarifas-info">
                Se muestran categor√≠a y monto actuales del puesto seleccionado.
              </p>
            </div>
          </div>
        </div>

        <!-- Resultado -->
        <div class="resultado" id="resultado">
          <div class="resultado-title">Resultado</div>
          <div class="resultado-item">
            <span class="resultado-label">Propietario:</span>
            <span class="resultado-value" id="resPropietario">-</span>
          </div>
          <div class="resultado-item">
            <span class="resultado-label">Categor√≠a:</span>
            <span class="resultado-value" id="resCategoria">-</span>
          </div>
          <div class="resultado-item">
            <span class="resultado-label">Bonificaci√≥n:</span>
            <span class="resultado-value" id="resBonificacion">-</span>
          </div>
          <div class="resultado-item">
            <span class="resultado-label">Costo del tr√°nsito:</span>
            <span class="resultado-value" id="resCosto">-</span>
          </div>
          <div class="resultado-item">
            <span class="resultado-label">Saldo luego del tr√°nsito:</span>
            <span class="resultado-value" id="resSaldo">-</span>
          </div>
        </div>
      </form>
    </div>

    <div class="footer">¬© 2025 ‚Äì Emular tr√°nsitos</div>

    <script src="utilesVista.js"></script>
    <script>
      // Configurar inicializaci√≥n de vista
      urlIniciarVista = "/emularTransito/vistaConectada";
      parametrosInicioVista = "";

      // Variables globales
      let posPuestoSeleccionado = -1;

      // Funciones para procesar respuestas del servidor
      function mostrar_puestos(data) {
        const select = document.getElementById("puesto");
        select.innerHTML = '<option value="">Seleccione un puesto</option>';

        data.forEach((puesto, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = puesto.nombre;
          select.appendChild(option);
        });
      }

      function mostrar_tarifas(data) {
        const tbody = document.querySelector("#tablaTarifas tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="2" style="text-align:center;color:#9ca3af">No hay tarifas disponibles</td></tr>';
          return;
        }

        data.forEach((tarifa) => {
          const tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" +
            tarifa.categoriaVehiculo +
            "</td><td>$ " +
            tarifa.monto.toFixed(2) +
            "</td>";
          tbody.appendChild(tr);
        });
      }

      function mostrar_transito(data) {
        document.getElementById("resPropietario").textContent =
          data.nombrePropietario + " (" + data.estadoPropietario + ")";
        document.getElementById("resCategoria").textContent =
          data.categoriaVehiculo;
        document.getElementById("resBonificacion").textContent =
          data.nombreBonificacion || "Sin bonificaci√≥n";
        document.getElementById("resCosto").textContent =
          "$ " + data.costoTransito.toFixed(2);
        document.getElementById("resSaldo").textContent =
          "$ " + data.saldoFinal.toFixed(2);

        document.getElementById("resultado").classList.add("show");
        document.getElementById("errorMessage").innerHTML = "";
      }

      function mostrar_error(mensaje) {
        document.getElementById("errorMessage").innerHTML =
          '<div class="error-message">' + mensaje + "</div>";
        document.getElementById("resultado").classList.remove("show");
      }

      function excepcionDeAplicacion(mensaje) {
        mostrar_error(mensaje);
      }

      // Event listener para selecci√≥n de puesto
      document
        .getElementById("puesto")
        .addEventListener("change", function (e) {
          posPuestoSeleccionado = parseInt(e.target.value);

          if (posPuestoSeleccionado >= 0) {
            // Solicitar tarifas del puesto seleccionado
            fetch(
              "/emularTransito/tarifasDePuesto?posPuesto=" +
                posPuestoSeleccionado
            )
              .then((response) => response.json())
              .then((data) => {
                if (Array.isArray(data)) {
                  data.forEach((respuesta) => {
                    if (respuesta.id === "tarifas") {
                      mostrar_tarifas(respuesta.parametro);
                    }
                  });
                }
              })
              .catch((error) => {
                console.error("Error al obtener tarifas:", error);
              });
          } else {
            // Limpiar tabla si no hay puesto seleccionado
            const tbody = document.querySelector("#tablaTarifas tbody");
            tbody.innerHTML =
              '<tr><td colspan="2" style="text-align:center;color:#9ca3af">Seleccione un puesto</td></tr>';
          }
        });

      // Event listener para el formulario
      document
        .getElementById("formEmularTransito")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          if (posPuestoSeleccionado < 0) {
            alert("Debe seleccionar un puesto");
            return;
          }

          const matricula = document.getElementById("matricula").value;
          const fechaHoraInput = document.getElementById("fechaHora").value;

          if (!matricula || !fechaHoraInput) {
            alert("Debe completar todos los campos");
            return;
          }

          // Convertir fecha local a timestamp
          const fechaHora = new Date(fechaHoraInput).getTime();

          const params =
            "posPuesto=" +
            posPuestoSeleccionado +
            "&matricula=" +
            encodeURIComponent(matricula) +
            "&fechaHora=" +
            fechaHora;

          submit("/emularTransito/emularTransito", params);
        });

      // Establecer fecha y hora actual por defecto
      window.addEventListener("DOMContentLoaded", function () {
        const ahora = new Date();
        ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
        document.getElementById("fechaHora").value = ahora
          .toISOString()
          .slice(0, 16);
      });
    </script>
  </body>
</html>
