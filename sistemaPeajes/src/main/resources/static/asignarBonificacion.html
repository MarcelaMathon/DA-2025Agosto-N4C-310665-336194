<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Asignar Bonificaciones</title>
    <link rel="stylesheet" href="styles/menuNavegacion.css" />
    <link rel="stylesheet" href="styles/asignarBonificacion.css" />
    <script src="vistaWeb.js"></script>
  </head>
  <body>
    <!-- Men√∫ de navegaci√≥n -->
    <nav class="nav-menu">
      <div class="nav-container">
        <div class="nav-brand">
          <span class="nav-brand-icon">üõ£Ô∏è</span>
          <span>Sistema de Peajes - Admin</span>
        </div>
        <ul class="nav-links">
          <li><a href="emularTransito.html">Emular Tr√°nsito</a></li>
          <li><a href="asignarBonificacion.html" class="active">Asignar Bonificaci√≥n</a></li>
          <li><a href="cambiarEstado.html">Cambiar Estado</a></li>
        </ul>
        <div class="nav-actions">
          <button class="btn-logout-nav" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="card">
        <div class="card-header">
          <div class="icon-title">
            <span class="icon">üìã</span>
            <h1>Asignar bonificaciones</h1>
          </div>
        </div>

        <div class="card-body">
          <div class="layout-two-columns">
            <!-- Columna izquierda -->
            <div class="left-column">
              <div class="form-section">
                <label for="selectBonificacion">Bonificaciones definidas</label>
                <select id="selectBonificacion" class="form-select">
                  <option value="">Seleccione una bonificaci√≥n</option>
                </select>
              </div>

              <div class="form-section">
                <label for="selectPuesto">Puestos definidos</label>
                <select id="selectPuesto" class="form-select">
                  <option value="">Seleccione un puesto</option>
                </select>
              </div>
            </div>

            <!-- Columna derecha -->
            <div class="right-column">
              <div class="form-section">
                <label for="cedula">C√©dula de identidad</label>
                <input
                  type="text"
                  id="cedula"
                  class="form-input"
                  placeholder="12345678"
                />
                <button onclick="buscarPropietario()" class="btn-primary">
                  Buscar propietario
                </button>
              </div>

              <div id="infoPropietario" class="info-card">
                <div class="info-header">Propietario</div>
                <div class="info-row">
                  <span class="info-label">Nombre:</span>
                  <span id="propNombre" class="info-value">-</span>
                </div>
                <div class="info-row">
                  <span class="info-label">Estado:</span>
                  <span id="propEstado" class="info-value">-</span>
                </div>

                <div class="bonificaciones-section">
                  <div class="bonificaciones-title">Bonificaciones asignadas</div>
                  <div id="tablaBonificaciones" class="table-wrapper">
                    <table>
                      <thead>
                        <tr>
                          <th>Bonificaci√≥n</th>
                          <th>Puesto</th>
                          <th>Fecha asignaci√≥n</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td colspan="3" class="empty-message">Sin bonificaciones asignadas</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="form-section">
                  <p class="help-text">
                    Seleccione bonificaci√≥n y puesto en las listas de la izquierda y luego asigne.
                  </p>
                  <button onclick="asignarBonificacion()" class="btn-primary">
                    Asignar bonificaci√≥n
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="mensajeResultado"></div>
        </div>

        <div class="card-footer">
          ¬© 2025 - Administraci√≥n
        </div>
      </div>
    </div>

    <script src="utilesVista.js"></script>
    <script>
      // Configurar inicializaci√≥n de vista
      urlIniciarVista = "/asignarBonificacion/vistaConectada";
      parametrosInicioVista = "";

      let propietarioActual = null;
      let posPuestoSeleccionado = -1;
      let nombreBonificacionSeleccionada = "";

      // Funciones para procesar respuestas del servidor
      function mostrar_bonificaciones(data) {
        const select = document.getElementById("selectBonificacion");
        select.innerHTML = '<option value="">Seleccione una bonificaci√≥n</option>';
        data.forEach((nombre, index) => {
          const option = document.createElement("option");
          option.value = nombre;
          option.textContent = nombre;
          select.appendChild(option);
        });
        
        select.addEventListener("change", function() {
          nombreBonificacionSeleccionada = this.value;
        });
      }

      function mostrar_puestos(data) {
        const select = document.getElementById("selectPuesto");
        select.innerHTML = '<option value="">Seleccione un puesto</option>';
        data.forEach((puesto, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = puesto.nombre;
          select.appendChild(option);
        });
        
        select.addEventListener("change", function() {
          posPuestoSeleccionado = parseInt(this.value);
        });
      }

      function mostrar_propietario(data) {
        propietarioActual = data;
        document.getElementById("propNombre").textContent = data.nombreCompleto;
        document.getElementById("propEstado").textContent = data.estado;
      }

      function mostrar_bonificacionesAsignadas(data) {
        const tbody = document.querySelector("#tablaBonificaciones tbody");
        tbody.innerHTML = "";
        
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty-message">Sin bonificaciones asignadas</td></tr>';
          return;
        }
        
        data.forEach(bonif => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${bonif.nombreBonificacion}</td>
            <td>${bonif.nombrePuesto}</td>
            <td>${bonif.fechaAsignacion}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function mostrar_mensaje(texto) {
        document.getElementById("mensajeResultado").innerHTML =
          '<div class="message success">' + texto + "</div>";
        setTimeout(() => {
          document.getElementById("mensajeResultado").innerHTML = "";
        }, 3000);
      }

      function excepcionDeAplicacion(mensaje) {
        document.getElementById("mensajeResultado").innerHTML =
          '<div class="message error">' + mensaje + "</div>";
      }

      // Funciones de botones
      function buscarPropietario() {
        const cedula = document.getElementById("cedula").value;
        if (!cedula) {
          alert("Debe ingresar una c√©dula");
          return;
        }
        const params = "cedula=" + encodeURIComponent(cedula);
        submit("/asignarBonificacion/buscarPropietario", params);
      }

      function asignarBonificacion() {
        if (!propietarioActual) {
          alert("Primero debe buscar un propietario");
          return;
        }
        if (posPuestoSeleccionado < 0) {
          alert("Debe seleccionar un puesto");
          return;
        }
        if (!nombreBonificacionSeleccionada) {
          alert("Debe seleccionar una bonificaci√≥n");
          return;
        }
        
        const params =
          "cedula=" +
          encodeURIComponent(propietarioActual.cedula) +
          "&posPuesto=" +
          posPuestoSeleccionado +
          "&nombreBonificacion=" +
          encodeURIComponent(nombreBonificacionSeleccionada);
        submit("/asignarBonificacion/asignar", params);
      }

      // Funci√≥n para cerrar sesi√≥n
      function cerrarSesion() {
        submit('/acceso/admin/logout', '');
      }

      function mostrar_Logout_exitoso(destino) {
        window.location.href = destino;
      }

      function mostrar_No_hay_usuario_logueado(destino) {
        window.location.href = destino;
      }

      function mostrar_usuarioNoAutenticado(destino) {
        window.location.href = destino;
      }
    </script>
  </body>
</html>
